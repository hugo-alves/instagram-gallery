(function(){window.keyCodes=$.extend({M:77,J:74,K:75,L:76,H:72},$.ui.keyCode);$("a[href='#']").live("click",function(a){return a.preventDefault()})}).call(this);(function(){$(function(){window.Filter=Backbone.Model.extend({initialize:function(){return _.bindAll(this,"getPhotos")},getPhotos:function(){return Photos.getAllByFilter(this.get("name"))}});return window.Photo=Backbone.Model.extend({initialize:function(){this.set({caption:{text:this.get("caption")===null?"no caption":void 0}});this.filterObj=Filters.addPhoto({photo:this});return _.bindAll(this,"collectionIndex")},collectionIndex:function(){return _.indexOf(this.collection.viewablePhotos(),this)},hasLocation:function(){if(this.get("location")&&this.get("location").longitude&&this.get("location").latitude){return true}else{return false}}})})}).call(this);(function(){$(function(){window.PhotoList=Backbone.Collection.extend({model:Photo,url:"/feed",initialize:function(){return _.bindAll(this,"viewablePhotos","getUsername")},getUsername:function(){return $("meta[name='username']").attr("content")},nextPhoto:function(b){var a;a=this.viewablePhotos();if(b.collectionIndex()===(a.length-1)){return _.first(a)}else{return a[b.collectionIndex()+1]}},prevPhoto:function(b){var a;a=this.viewablePhotos();if(b.collectionIndex()===0){return _.last(a)}else{return a[b.collectionIndex()-1]}},getAllByFilter:function(a){return _.select(this.models,function(b){return b.get("filter")===a})},selectedThumbnail:function(){return this.selected},viewablePhotos:function(){return _.select(this.models,function(a){return $(a.view.el).find("img").is(":visible")})}});return window.FilterList=Backbone.Collection.extend({model:Filter,getByName:function(a){return _.select(this.models,function(b){return b.get("name")===a})[0]},addPhoto:function(b){var c,a;a=b.photo;c=this.getByName(a.get("filter"));if(!c){c=new Filter({name:a.get("filter")});this.add(c)}return c}})})}).call(this);(function(){$(function(){window.ApplicationView=Backbone.View.extend({initialize:function(){_.bindAll(this,"resetUI");this.routes=new Workspace;this.loading=new LoadingView;this.loading.render();Photos.fetch({success:function(){App.render();return Backbone.history.start({pushState:true,root:"#/"})}});return this},render:function(){$(this.el).insertAfter("#nav").attr("id","gallery").addClass("fixed").empty();_.each(Photos.models,function(a){return new PhotoThumbnailView({model:a}).render()});_.each(Filters.models,function(a){return new FilterView({model:a}).render()});this.loading.close();return this},resetUI:function(){if(App.expandedView){App.expandedView.close()}$(App.el).removeClass("filtered");$(".thumbnail.highlight, .filter.highlight").removeClass("highlight");return this}});window.PhotoThumbnailView=Backbone.View.extend({className:"thumbnail",template:_.template('<a href="#" title="<%= caption.text %> - view larger"><img src="<%= thumbnail.url %>" width="<%= thumbnail.width %>" height="<%= thumbnail.height %>" alt="<%= caption.text %>"></a>'),events:{"click a":"showExpanded"},initialize:function(){_.bindAll(this,"showExpanded","select","highlight");this.model=this.options.model;this.model.view=this;return this.scrollOffset=-150},render:function(){$(this.el).append(this.template({id:this.model.get("id"),thumbnail:this.model.get("images").thumbnail,filter:this.model.get("filter"),caption:this.model.get("caption")})).attr("id","photo_thumbnail_"+this.model.get("id")).appendTo(App.el);return this},showExpanded:function(a){if(App.expandedView){App.expandedView.remove()}App.expandedView=new PhotoExpandedView({model:this.model});return App.expandedView.render()},scroll:function(){var a;a=this;clearInterval(window.scrollDelay);window.scrollDelay=setTimeout(function(){return $("html").stop(true,true).scrollTo($(a.el),300,{offset:a.scrollOffset})},300);return this},select:function(){var a;a=this;_.once(function(){a.model.collection.selected=a.model;Photos.selectedThumbnailView=a;$("."+a.className+".selected").removeClass("selected");$(a.el).addClass("selected");if(!App.expandedView){return a.scroll()}})();return this},highlight:function(){$(this.el).addClass("highlight");return this}});window.PhotoExpandedView=Backbone.View.extend({className:"expanded",events:{"click .close":"close"},initialize:function(){App.expandedView=this;this.model=this.options.model;_.bindAll(this,"openMap","close","nextPhoto","prevPhoto");return this},render:function(){$("body").addClass("expanded");$(this.el).appendTo("body").css("height",$(document).height());this.photo=new PhotoStandardResolutionView({model:this.model,baseView:this}).render();this.navigation=new PhotoExpandedNavigationView().render();$(this.el).find(".photo img").hide().load(function(){return $(this).fadeIn()});this.scroll();$(this.model.view).select();return this},close:function(){App.expandedView.remove();App.expandedView=null;$("body").removeClass("expanded");return Photos.selected.view.scroll()},prevPhoto:function(){this.navigation.prevPhoto();return this},nextPhoto:function(){this.navigation.nextPhoto();return this},openMap:function(){return this.navigation.openMap()},openExternal:function(a){return this.photo.userView.openExternal(a)},scroll:function(){var a;a=this;clearInterval(window.scrollDelay);return window.scrollDelay=setTimeout(function(){return $("html").stop(true,true).scrollTo($(a.el),300)},300)}});window.PhotoExpandedNavigationView=Backbone.View.extend({className:"navigation",template:_.template('<a href="#" id="closePhoto">Close</a><a href="#" id="nextPhoto">Next</a> <a href="#" id="prevPhoto">Prev</a>'),events:{"click #nextPhoto":"nextPhoto","click #prevPhoto":"prevPhoto","click #closePhoto":"closePhoto"},initialize:function(){this.model=App.expandedView.model;_.bindAll(this,"openMap","nextPhoto","prevPhoto");return this},render:function(){$(this.el).html(this.template(this.model.toJSON())).prependTo(App.expandedView.photo.container());return this},nextPhoto:function(a){App.expandedView.close();App.expandedView=new PhotoExpandedView({model:Photos.nextPhoto(this.model)});return App.expandedView.render()},prevPhoto:function(a){App.expandedView.close();App.expandedView=new PhotoExpandedView({model:Photos.prevPhoto(this.model)});return App.expandedView.render()},openMap:function(a){if(this.model.hasLocation()){if(this.mapView){this.mapView.close();this.mapView=null;$("a.map").removeClass("active")}else{this.mapView=new PhotoMapView({appendView:App.expandedView.photo,location:this.model.get("location")});this.mapView.render();$("a.map").addClass("active")}}return this},closePhoto:function(){return App.expandedView.close()}});window.PhotoMapView=Backbone.View.extend({tagName:"div",className:"expandedMap",initialize:function(){this.latlng=new google.maps.LatLng(this.options.location.latitude,this.options.location.longitude);return this.appendView=this.options.appendView},render:function(){var b,a;a=this.latlng;b=this.el;$(b).appendTo(this.appendView.el).gmap({center:a,callback:function(){return $(b).gmap("addMarker",{position:a})}}).append($('<img src="/images/map.arrow.png" width="20" height="20" class="map-arrow" />')).position({of:".map",at:"left top",my:"right bottom",offset:"55px -20px",collision:"none"});return this},close:function(){return $(this.el).remove()}});window.PhotoStandardResolutionView=PhotoThumbnailView.extend({className:"standard-resolution",template:_.template('<div class="container"><div class="photo"><img src="<%= images.standard_resolution.url %>" alt="<%= caption.text %>" width="<%= images.standard_resolution.width %>"></div></div>'),container:function(){return $(this.el).find(".container:first")},initialize:function(){this.model=this.options.model;this.baseView=this.options.baseView;if(!this.baseView){this.baseView=App;this.model.view=this}this.userView=new UserView({model:this.model,modelView:this});this.scrollOffset=0;return this},showExpanded:function(){return showExpanded.__super__.constructor.apply(this,arguments)},render:function(){$(this.el).html(this.template(this.model.toJSON())).appendTo(this.baseView.el);this.userView.render();return this}});window.UserView=Backbone.View.extend({className:"user",template:_.template('<div class="container"><img src="<%= user.profile_picture %>" alt="<%= user.username %>" class="avatar" /> <div class="profile"><h3><%= user.full_name || user.username %></h3><% if ( user.full_name ) { %><h4><%= user.username %></h4><% } %></div> <div class="filter"><h6>Filter:</h6><h3><%= filter %></h3> <a href="#" class="view-all-filter">View All</a></div> <div class="links"> <% if ( (location) && (location.latitude) ) { %><a href="#" id="viewMap" class="map">View on Map</a><% } %><a href="<%= link %>" id="viewExternal" class="instagram">View on Instagram</a></div></div>'),events:{"click #viewMap":"showMap","click .view-all-filter":"viewFilter","click #viewExternal":"openExternal"},initialize:function(){this.model=this.options.model;this.modelView=this.options.modelView;return _.bindAll(this,"openExternal")},render:function(){$(this.el).html(this.template(this.model.toJSON())).appendTo(this.modelView.el);return this},showMap:function(a){a.preventDefault();App.expandedView.navigation.openMap();return this},viewFilter:function(){App.routes.navigate("filters/"+this.model.get("filter"),true);return this},openExternal:function(a){a.preventDefault();window.open(this.model.get("link"),"instagram");return this}});window.FilterView=Backbone.View.extend({wrapper:"#filters-list",tagName:"li",className:"filter",events:{click:"togglePhotos"},template:_.template('<a href="#" class="toggle-filter" title="View <%= filter_name %> photos"><%= filter_name %></a>'),initialize:function(){this.model=this.options.model;this.model.view=this;if(!$(this.wrapper).length){$("<ul/>").attr("id","filters-list").appendTo(App.el);this.setWaypoint()}return _.bindAll(this,"setWaypoint")},render:function(){$(this.el).appendTo(this.wrapper).html(this.template({filter_name:this.model.get("name"),length:this.model.getPhotos().length}));return this},hideFilterPhotos:function(a){$(".thumbnail").removeClass("blur");return $(".filter").removeClass("blur")},togglePhotos:function(f){var c,d,b,a;f.preventDefault();b=this.model.get("name");d=window.location.hash;a="";if(d.indexOf("#/filters/")!==-1){a=d.replace("#/filters/","").replace("#/","")}c=_.compact(a.split(":"));if((_.include(c,b))&&c.length){c=_.without(c,b).join(":")}else{c.push(b);c=c.join(":")}return App.routes.navigate("filters/"+c,true)},setWaypoint:function(){return $("#footer").waypoint((function(a,b){return $(App.el).toggleClass("fixed",b==="up")}),{offset:"100%"})}});return window.LoadingView=Backbone.View.extend({className:"loader",template:_.template('<img src="/images/loader.big.gif" />'),initialize:function(){_.bindAll(this,"close","render");return this},render:function(){$("body").addClass("loading").append($(this.el).html(this.template));return this},close:function(){$(this.el).fadeOut("fast",function(){return $(this).remove()});$("body").removeClass("loading").addClass("loaded");return this}})})}).call(this);(function(){$(function(){var b,a;window.Photos=new PhotoList;window.Filters=new FilterList;window.Workspace=Backbone.Router.extend({routes:{"":"resetUI","/filters/:ids":"filters"},resetUI:function(){return App.resetUI()},filters:function(c){var d;App.resetUI();d=c.split(":");if(c&&d){$(App.el).addClass("filtered");if(d.length>=Filters.models.length){window.location.hash="#/";$("html").stop().scrollTo("#nav",800)}return _.each(d,function(f){var e,g;e=Filters.getByName(f);if(e){g=e.getPhotos();if(e){_.each(g,function(h){return h.view.highlight()});_.first(Photos.viewablePhotos()).view.select().scroll()}return $(e.view.el).addClass("highlight")}})}else{window.location.hash="#/";return $("html").stop().scrollTo("#nav",800)}}});window.App=new ApplicationView;a=function(h){var d,g,f,i,c;c=Photos.viewablePhotos();i=Photos.selectedThumbnail();d=function(){if(i){return i.view.showExpanded()}};f=function(){h.preventDefault();if(!i){return _.first(c).view.select()}else{return Photos.nextPhoto(i).view.select()}};g=function(){h.preventDefault();if(!i){i=_.last(c).view.select()}else{i=Photos.prevPhoto(i).view.select()}return i.select()};switch(h.which){case keyCodes.RIGHT:return f();case keyCodes.LEFT:return g();case keyCodes.UP:return g();case keyCodes.DOWN:return f();case keyCodes.ENTER:h.preventDefault();return d();case keyCodes.SPACE:h.preventDefault();return d()}};b=function(d){var c;c=function(){return App.expandedView.close()};switch(d.which){case keyCodes.DOWN:d.preventDefault();return App.expandedView.nextPhoto(d);case keyCodes.RIGHT:d.preventDefault();return App.expandedView.nextPhoto(d);case keyCodes.UP:d.preventDefault();return App.expandedView.prevPhoto(d);case keyCodes.LEFT:d.preventDefault();return App.expandedView.prevPhoto(d);case keyCodes.ESCAPE:return c();case keyCodes.SPACE:d.preventDefault();return c();case keyCodes.ENTER:return c();case keyCodes.M:return App.expandedView.openMap(d);case 86:return App.expandedView.openExternal(d)}};return $(document).bind("keydown",function(c){if($(".expanded img").length){return b(c)}else{return a(c)}})})}).call(this);